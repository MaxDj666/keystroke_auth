{% extends "base.html" %}

{% block title %}–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ—á–µ—Ä–∫–∞ - Keystroke Dynamics Auth{% endblock %}

{% block body %}
<div class="container">
    <div class="card" style="max-width: 600px; margin: 0 auto;">
        <div class="header">
            <h1>üîç –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–æ–≥–æ –ø–æ—á–µ—Ä–∫–∞</h1>
            <p>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∞—à—É –ª–∏—á–Ω–æ—Å—Ç—å</p>
        </div>
        <div class="content">
            <div id="message" class="message"></div>

            <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0; text-align: center;">
                <p style="font-size: 12px; color: #856404;"><strong>‚ö†Ô∏è –í–∞–∂–Ω–æ:</strong> –ü–µ—á–∞—Ç–∞–π—Ç–µ –≤ –æ–±—ã—á–Ω–æ–º —Ç–µ–º–ø–µ –∏ —Å—Ç–∏–ª–µ. –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–∞—à—É –¥–∏–Ω–∞–º–∏–∫—É –ø–µ—á–∞—Ç–∏.</p>
            </div>

            <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 20px 0; text-align: center;">
                <p style="font-size: 14px; font-weight: bold; color: #1976d2;">
                    {{ verify_text or "The quick brown fox jumps over the lazy dog" }}
                </p>
            </div>

            <div class="form-group">
                <label for="verifyInputArea">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏:</label>
                <textarea id="verifyInputArea" placeholder="–ü–µ—á–∞—Ç–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –∑–¥–µ—Å—å..."></textarea>
            </div>

            <div class="stats" style="display: none;" id="verifyStats">
                <div class="stat-item">
                    <div class="stat-value" id="verifyTypingSpeed">0</div>
                    <div class="stat-label">–°–∏–º/—Å–µ–∫</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="verifyDwellTime">0</div>
                    <div class="stat-label">–ú—Å (–Ω–∞–∂–∞—Ç–∏–µ)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="verifyFlightTime">0</div>
                    <div class="stat-label">–ú—Å (–º–µ–∂–¥—É)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="matchScore">--</div>
                    <div class="stat-label">–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ</div>
                </div>
            </div>

            <div style="display: flex; gap: 10px;">
                <button type="button" class="btn btn-primary" id="verifyBtn" style="flex: 1;">üîê –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å</button>
                <button type="button" class="btn btn-secondary" id="verifyClearBtn" style="flex: 1;">‚Üª –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>

            <div class="link">
                –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ <a href="/login">–≤—Ö–æ–¥—É</a>
            </div>
        </div>
    </div>
</div>

<script>
const verifyInputArea = document.getElementById('verifyInputArea');
const verifyBtn = document.getElementById('verifyBtn');
const verifyClearBtn = document.getElementById('verifyClearBtn');
const verifyStats = document.getElementById('verifyStats');

let verifyKeystrokeEvents = [];
let verifyStartTime = 0;

verifyBtn.addEventListener('click', async () => {
    if (verifyKeystrokeEvents.length < 20) {
        window.showMessage('–ù–∞–ø–µ—á–∞—Ç–∞–π—Ç–µ –±–æ–ª—å—à–µ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏', 'error');
        return;
    }

    verifyBtn.disabled = true;
    verifyBtn.textContent = '–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è...';

    try {
        const response = await fetch('/verify-keystroke', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ keystroke_events: verifyKeystrokeEvents })
        });

        const data = await response.json();

        if (response.ok && data.verified) {
            window.showMessage('‚úì –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', 'success');
            setTimeout(() => {
                window.location.href = '/dashboard';
            }, 2000);
        } else {
            const score = (data.similarity * 100).toFixed(0);
            const message = `–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞ (—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ: ${score}%). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.`;
            window.showMessage(message, 'error');
        }
    } catch (error) {
        window.showMessage('–û—à–∏–±–∫–∞: ' + error.message, 'error');
    }

    verifyBtn.disabled = false;
    verifyBtn.textContent = 'üîê –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å';
});

verifyClearBtn.addEventListener('click', () => {
    verifyInputArea.value = '';
    verifyKeystrokeEvents = [];
    verifyStats.style.display = 'none';
});

verifyInputArea.addEventListener('keydown', (e) => {
    if (verifyKeystrokeEvents.length === 0) {
        verifyStartTime = Date.now();
    }

    verifyKeystrokeEvents.push({
        keycode: e.keyCode,
        key_char: e.key,
        press_time: Date.now() - verifyStartTime,
        release_time: null
    });
});

verifyInputArea.addEventListener('keyup', (e) => {
    if (verifyKeystrokeEvents.length > 0) {
        const lastEvent = verifyKeystrokeEvents[verifyKeystrokeEvents.length - 1];
        if (lastEvent.release_time === null) {
            lastEvent.release_time = Date.now() - verifyStartTime;
        }

        updateVerifyStats();
    }
});

function updateVerifyStats() {
    if (verifyKeystrokeEvents.length < 5) return;

    verifyStats.style.display = 'grid';

    const dwellTimes = verifyKeystrokeEvents.map(e => e.release_time - e.press_time).filter(t => t > 0);
    const avgDwell = dwellTimes.length > 0 ? (dwellTimes.reduce((a, b) => a + b) / dwellTimes.length).toFixed(0) : 0;

    const flightTimes = [];
    for (let i = 0; i < verifyKeystrokeEvents.length - 1; i++) {
        const flight = verifyKeystrokeEvents[i + 1].press_time - verifyKeystrokeEvents[i].release_time;
        if (flight >= 0) flightTimes.push(flight);
    }
    const avgFlight = flightTimes.length > 0 ? (flightTimes.reduce((a, b) => a + b) / flightTimes.length).toFixed(0) : 0;

    const totalTime = (verifyKeystrokeEvents[verifyKeystrokeEvents.length - 1].release_time - verifyKeystrokeEvents[0].press_time) / 1000;
    const speed = totalTime > 0 ? (verifyKeystrokeEvents.length / totalTime).toFixed(1) : 0;

    document.getElementById('verifyDwellTime').textContent = avgDwell;
    document.getElementById('verifyFlightTime').textContent = avgFlight;
    document.getElementById('verifyTypingSpeed').textContent = speed;
    document.getElementById('matchScore').textContent = '‚è≥ –ê–Ω–∞–ª–∏–∑...';
}
</script>
{% endblock %}
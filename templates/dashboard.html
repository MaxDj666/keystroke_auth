{% extends "base.html" %}

{% block title %}–ó–∞—â–∏—â–µ–Ω–Ω–∞—è –æ–±–ª–∞—Å—Ç—å - Keystroke Dynamics Auth{% endblock %}

{% block body %}
<style>
    .navbar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .navbar h2 {
        margin: 0;
    }

    .navbar-right {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        background: #4caf50;
        border-radius: 50%;
        display: inline-block;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .status-indicator.warning {
        background: #ff9800;
    }

    .status-indicator.danger {
        background: #f44336;
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .dashboard-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
    }

    .dashboard-card h3 {
        color: #667eea;
        margin-bottom: 15px;
        font-size: 18px;
    }

    .work-area {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin: 20px 0;
    }

    .work-textarea {
        width: 100%;
        min-height: 300px;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 5px;
        font-family: monospace;
        font-size: 14px;
        resize: vertical;
    }

    .alert {
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
        display: none;
    }

    .alert.show {
        display: block;
    }

    .alert-warning {
        background: #fff3cd;
        border: 1px solid #ffeeba;
        color: #856404;
    }

    .alert-danger {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .logout-btn {
        background: #f44336;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
    }

    .logout-btn:hover {
        background: #d32f2f;
    }

    body.main-layout {
        background: #f5f5f5;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .main-layout .container {
        flex: 1;
        padding-bottom: 40px;
    }
</style>

<body class="main-layout">
    <div class="navbar">
        <h2>üîê –ó–∞—â–∏—â–µ–Ω–Ω–∞—è –æ–±–ª–∞—Å—Ç—å</h2>
        <div class="navbar-right">
            <div>
                üë§ {{ username }}
                <span class="status-indicator" id="statusIndicator" title="–°—Ç–∞—Ç—É—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"></span>
                <span id="statusText" style="font-size: 12px; margin-left: 5px;">–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω</span>
            </div>
            <button class="logout-btn" onclick="logout()">–í—ã—Ö–æ–¥</button>
        </div>
    </div>

    <div class="container">
        <div id="warningAlert" class="alert alert-warning">
            <strong>‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:</strong> –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–æ–≥–æ –ø–æ—á–µ—Ä–∫–∞. 
            <span id="warningCount">–ü–æ–ø—ã—Ç–æ–∫: 1/3</span>
        </div>

        <div id="dangerAlert" class="alert alert-danger">
            <strong>üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:</strong> –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ä–µ–∑–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—á–µ—Ä–∫–∞. 
            –°–µ—Å—Å–∏—è –±—É–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –≤ <span id="countdownTimer">10</span> —Å–µ–∫.
        </div>

        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è</h3>
                <div style="font-size: 12px; color: #666;">
                    <p>–û–±—Ä–∞–∑—Ü–æ–≤: <strong id="profileCount">-</strong></p>
                    <p>–°–æ–±—ã—Ç–∏–π: <strong id="eventCount">-</strong></p>
                    <p>–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å: <strong id="avgSpeed">-</strong> —Å–∏–º/—Å–µ–∫</p>
                    <p>–°—Ä–µ–¥–Ω–µ–µ –Ω–∞–∂–∞—Ç–∏–µ: <strong id="avgDwell">-</strong> –º—Å</p>
                </div>
            </div>

            <div class="dashboard-card">
                <h3>üîç –¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è</h3>
                <div style="font-size: 12px; color: #666;">
                    <p>–°—Ç–∞—Ç—É—Å: <strong id="sessionStatus">–ê–∫—Ç–∏–≤–Ω–∞</strong></p>
                    <p>–û—Ü–µ–Ω–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è: <strong id="authScore">-</strong></p>
                    <p>–ü—Ä–æ–≤–µ—Ä–æ–∫: <strong id="checkCount">0</strong></p>
                    <p>–ê–Ω–æ–º–∞–ª–∏–π: <strong id="anomalyCount">0</strong></p>
                </div>
            </div>

            <div class="dashboard-card">
                <h3>‚å®Ô∏è –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</h3>
                <div style="font-size: 12px; color: #666;">
                    <p>–¢–µ–∫—É—â–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å: <strong id="currentSpeed">-</strong> —Å–∏–º/—Å–µ–∫</p>
                    <p>–•–∞—Ä–∞–∫—Ç–µ—Ä –Ω–∞–∂–∞—Ç–∏—è: <strong id="keystrokePattern">-</strong></p>
                    <p>–†–∏—Ç–º–∏—á–Ω–æ—Å—Ç—å: <strong id="rhythm">-</strong></p>
                    <p>–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: <strong id="consistency">-</strong></p>
                </div>
            </div>
        </div>

        <div class="work-area">
            <h3>‚úçÔ∏è –†–∞–±–æ—á–∞—è –æ–±–ª–∞—Å—Ç—å</h3>
            <p style="color: #666; font-size: 12px; margin-bottom: 10px;">
                –ü–µ—á–∞—Ç–∞–π—Ç–µ –∑–¥–µ—Å—å. –í–∞—à –ø–æ—á–µ—Ä–∫ –±—É–¥–µ—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å—Å—è –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π.
            </p>
            <textarea class="work-textarea" id="workTextarea" placeholder="–ü–µ—á–∞—Ç–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –∑–¥–µ—Å—å...
–°–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å:
‚Ä¢ –°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—á–∞—Ç–∏
‚Ä¢ –í—Ä–µ–º—è –Ω–∞–∂–∞—Ç–∏—è
‚Ä¢ –†–∏—Ç–º –ø–µ—á–∞—Ç–∏
‚Ä¢ –ü—Ä–µ—Ä—ã–≤–∏—Å—Ç–æ—Å—Ç—å –º–µ–∂–¥—É —Å–∏–º–≤–æ–ª–∞–º–∏

–ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –∞–Ω–æ–º–∞–ª–∏–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ."></textarea>
        </div>
    </div>
</body>

<script>
const statusIndicator = document.getElementById('statusIndicator');
const statusText = document.getElementById('statusText');
const warningAlert = document.getElementById('warningAlert');
const dangerAlert = document.getElementById('dangerAlert');
const workTextarea = document.getElementById('workTextarea');

let keystrokeBuffer = [];
let sessionKeystrokeCount = 0;
let anomalyWarnings = 0;
let isSessionValid = true;
const MAX_WARNINGS = 3;
const CHECK_INTERVAL = 20; // –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 20 —Å–∏–º–≤–æ–ª–æ–≤

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
async function loadProfileStats() {
    try {
        const stats = await fetch('/api/profile-stats').then(r => r.json());
        document.getElementById('profileCount').textContent = stats.profiles_count;
        document.getElementById('eventCount').textContent = stats.keystroke_events;
        document.getElementById('avgSpeed').textContent = stats.avg_typing_speed.toFixed(1);
        document.getElementById('avgDwell').textContent = Math.round(stats.avg_dwell_time);
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', e);
    }
}

// –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
async function performContinuousAuth() {
    if (!isSessionValid || keystrokeBuffer.length < CHECK_INTERVAL) return;

    try {
        const response = await fetch('/api/continuous-auth', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ keystroke_events: keystrokeBuffer })
        });

        const data = await response.json();

        if (response.ok) {
            document.getElementById('checkCount').textContent = 
                (parseInt(document.getElementById('checkCount').textContent) + 1);
            document.getElementById('authScore').textContent = 
                (data.score * 100).toFixed(0) + '%';

            if (data.is_anomaly) {
                document.getElementById('anomalyCount').textContent = 
                    (parseInt(document.getElementById('anomalyCount').textContent) + 1);
                anomalyWarnings++;

                if (anomalyWarnings >= MAX_WARNINGS) {
                    // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                    triggerSessionTermination();
                } else {
                    // –û–±—ã—á–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                    warningAlert.classList.add('show');
                    document.getElementById('warningCount').textContent = 
                        `–ü–æ–ø—ã—Ç–æ–∫: ${anomalyWarnings}/${MAX_WARNINGS}`;
                    statusIndicator.className = 'status-indicator warning';
                    statusText.textContent = '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∞–Ω–æ–º–∞–ª–∏—è';

                    setTimeout(() => {
                        warningAlert.classList.remove('show');
                        statusIndicator.className = 'status-indicator';
                        statusText.textContent = '–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω';
                    }, 5000);
                }
            } else {
                anomalyWarnings = 0;
                statusIndicator.className = 'status-indicator';
                statusText.textContent = '–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω';
            }
        } else if (response.status === 401) {
            // –ù–µ—É–¥–∞—á–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
            triggerSessionTermination();
        }

        keystrokeBuffer = [];
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:', e);
    }
}

function triggerSessionTermination() {
    isSessionValid = false;
    statusIndicator.className = 'status-indicator danger';
    statusText.textContent = '–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è';
    dangerAlert.classList.add('show');

    let countdown = 10;
    const interval = setInterval(() => {
        countdown--;
        document.getElementById('countdownTimer').textContent = countdown;

        if (countdown <= 0) {
            clearInterval(interval);
            logout();
        }
    }, 1000);
}

async function logout() {
    try {
        await fetch('/logout', { method: 'POST' });
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', e);
    }
    window.location.href = '/login';
}

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–∞–∂–∞—Ç–∏–π –∫–ª–∞–≤–∏—à
let workStartTime = 0;

workTextarea.addEventListener('keydown', (e) => {
    if (!isSessionValid) {
        e.preventDefault();
        return;
    }

    if (keystrokeBuffer.length === 0) {
        workStartTime = Date.now();
    }

    keystrokeBuffer.push({
        keycode: e.keyCode,
        key_char: e.key,
        press_time: Date.now() - workStartTime,
        release_time: null
    });

    sessionKeystrokeCount++;
});

workTextarea.addEventListener('keyup', (e) => {
    if (keystrokeBuffer.length > 0) {
        const lastEvent = keystrokeBuffer[keystrokeBuffer.length - 1];
        if (lastEvent.release_time === null) {
            lastEvent.release_time = Date.now() - workStartTime;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ CHECK_INTERVAL —Å–∏–º–≤–æ–ª–æ–≤
        if (keystrokeBuffer.length % CHECK_INTERVAL === 0) {
            performContinuousAuth();
        }

        updateCurrentStats();
    }
});

function updateCurrentStats() {
    if (keystrokeBuffer.length < 2) return;

    const dwellTimes = keystrokeBuffer.map(e => e.release_time - e.press_time).filter(t => t > 0);
    const avgDwell = dwellTimes.length > 0 ? (dwellTimes.reduce((a, b) => a + b) / dwellTimes.length).toFixed(0) : 0;

    const flightTimes = [];
    for (let i = 0; i < keystrokeBuffer.length - 1; i++) {
        const flight = keystrokeBuffer[i + 1].press_time - keystrokeBuffer[i].release_time;
        if (flight >= 0) flightTimes.push(flight);
    }

    const totalTime = (keystrokeBuffer[keystrokeBuffer.length - 1].release_time - keystrokeBuffer[0].press_time) / 1000;
    const speed = totalTime > 0 ? (keystrokeBuffer.length / totalTime).toFixed(1) : 0;

    document.getElementById('currentSpeed').textContent = speed;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
loadProfileStats();
setInterval(loadProfileStats, 5000);
</script>
{% endblock %}
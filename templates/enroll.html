{% extends "base.html" %}

{% block title %}–≠–Ω—Ä–æ–ª–º–µ–Ω—Ç –ø–æ—á–µ—Ä–∫–∞ - Keystroke Dynamics Auth{% endblock %}

{% block body %}
<div class="container">
    <div class="card" style="max-width: 600px; margin: 0 auto;">
        <div class="header">
            <h1>‚úçÔ∏è –≠–Ω—Ä–æ–ª–º–µ–Ω—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–æ–≥–æ –ø–æ—á–µ—Ä–∫–∞</h1>
            <p>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–∞—à–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∏–ª—è –ø–µ—á–∞—Ç–∏</p>
        </div>
        <div class="content">
            <div id="message" class="message"></div>

            <div class="progress">
                <div class="progress-bar">
                    <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
                </div>
                <div style="text-align: center; font-size: 12px; color: #666; margin-top: 8px;">
                    –û–±—Ä–∞–∑–µ—Ü <span id="sampleNum">1</span> –∏–∑ <span id="totalSamples">5</span>
                </div>
            </div>

            <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 20px 0;">
                <p style="font-size: 12px; color: #666; margin-bottom: 10px;"><strong>üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong></p>
                <ul style="font-size: 12px; color: #666; padding-left: 20px;">
                    <li>–ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∏–∂–µ</li>
                    <li>–ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å"</li>
                    <li>–ü–µ—á–∞—Ç–∞–π—Ç–µ —Ç–µ–∫—Å—Ç —Ä–æ–≤–Ω–æ –∫–∞–∫ –ø–æ–∫–∞–∑–∞–Ω–æ</li>
                    <li>–°–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à –ø–æ—á–µ—Ä–∫</li>
                    <li>–ù–∞–∂–º–∏—Ç–µ "–ó–∞–≤–µ—Ä—à–∏—Ç—å" –∫–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—Ç–µ</li>
                </ul>
            </div>

            <div style="background: #e8f5e9; padding: 15px; border-radius: 5px; margin: 20px 0; text-align: center;">
                <p style="font-size: 14px; font-weight: bold; color: #2e7d32;" id="enrollmentText">
                    The quick brown fox jumps over the lazy dog
                </p>
            </div>

            <div class="form-group">
                <label for="inputArea">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–¥–µ—Å—å:</label>
                <textarea id="inputArea" placeholder="–ü–µ—á–∞—Ç–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –∑–¥–µ—Å—å..."></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button type="button" class="btn btn-primary" id="startBtn" style="flex: 1;">‚ñ∂ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
                <button type="button" class="btn btn-secondary" id="clearBtn" style="flex: 1;">‚Üª –û—á–∏—Å—Ç–∏—Ç—å</button>
                <button type="button" class="btn btn-secondary" id="submitBtn" style="flex: 1; display: none;">‚úì –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
            </div>

            <div id="stats" style="display: none; margin-top: 20px;">
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="typingSpeed">0</div>
                        <div class="stat-label">–°–∏–º/—Å–µ–∫</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="dwellTime">0</div>
                        <div class="stat-label">–ú—Å (–Ω–∞–∂–∞—Ç–∏–µ)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="flightTime">0</div>
                        <div class="stat-label">–ú—Å (–º–µ–∂–¥—É)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="accuracy">0%</div>
                        <div class="stat-label">–¢–æ—á–Ω–æ—Å—Ç—å</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const enrollmentText = "The quick brown fox jumps over the lazy dog";
const inputArea = document.getElementById('inputArea');
const startBtn = document.getElementById('startBtn');
const clearBtn = document.getElementById('clearBtn');
const submitBtn = document.getElementById('submitBtn');
const enrollmentDisplay = document.getElementById('enrollmentText');
const statsDiv = document.getElementById('stats');

let keystrokeEvents = [];
let isRecording = false;
let startTime = 0;
let currentIndex = 0;
let samplesCollected = 0;  // ‚Üê –î–û–ë–ê–í–õ–ï–ù–û: –ª–æ–∫–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –æ–±—Ä–∞–∑—Ü–æ–≤

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ (–ª–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è)
function updateProgressBar() {
    const currentSample = samplesCollected + 1;  // ‚Üê –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫
    document.getElementById('sampleNum').textContent = currentSample;
    document.getElementById('progressBar').style.width = (currentSample / 5 * 100) + '%';
    console.log('Progress updated:', currentSample, '/', 5);  // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –æ–±—Ä–∞–∑—Ü–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
async function fetchSampleCount() {
    try {
        const stats = await fetch('/api/profile-stats').then(r => r.json());
        samplesCollected = stats.profiles_count;  // ‚Üê –°–û–•–†–ê–ù–Ø–ï–ú –í –õ–û–ö–ê–õ–¨–ù–£–Æ –ü–ï–†–ï–ú–ï–ù–ù–£–Æ
        updateProgressBar();
        console.log('Samples from server:', samplesCollected);
    } catch (e) {
        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:', e);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
fetchSampleCount();

startBtn.addEventListener('click', () => {
    inputArea.disabled = false;
    inputArea.focus();
    inputArea.value = '';
    keystrokeEvents = [];
    isRecording = true;
    startTime = Date.now();
    currentIndex = 0;

    startBtn.style.display = 'none';
    submitBtn.style.display = 'block';
    statsDiv.style.display = 'none';
    clearBtn.disabled = true;

    // –°–±—Ä–æ—Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
    enrollmentDisplay.innerHTML = '<span style="background: #ffeb3b; font-weight: bold;">' + enrollmentText[0] + '</span>' + enrollmentText.substring(1);

    window.showMessage('–ù–∞—á–∏–Ω–∞–π—Ç–µ –ø–µ—á–∞—Ç—å...', 'info');
});

clearBtn.addEventListener('click', () => {
    inputArea.value = '';
    keystrokeEvents = [];
    currentIndex = 0;
    statsDiv.style.display = 'none';
    // –°–±—Ä–æ—Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
    enrollmentDisplay.innerHTML = enrollmentText;
});

submitBtn.addEventListener('click', async () => {
    isRecording = false;
    inputArea.disabled = true;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω–∞–ø–µ—á–∞—Ç–∞–Ω –ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ç–µ–∫—Å—Ç
    const typed = inputArea.value.trim();
    const accuracy = calculateAccuracy(typed, enrollmentText);

    console.log('Typed:', typed);
    console.log('Expected:', enrollmentText);
    console.log('Accuracy:', accuracy);

    if (accuracy < 0.8) {
        window.showMessage(`–¢–µ–∫—Å—Ç –≤–≤–µ–¥–µ–Ω –Ω–µ–≤–µ—Ä–Ω–æ (—Ç–æ—á–Ω–æ—Å—Ç—å: ${(accuracy * 100).toFixed(0)}%). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.`, 'error');
        startBtn.style.display = 'block';
        submitBtn.style.display = 'none';
        clearBtn.disabled = false;
        inputArea.disabled = false;
        isRecording = false;
        return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';

    try {
        const response = await fetch('/enroll', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ keystroke_events: keystrokeEvents })
        });

        const data = await response.json();

        if (response.ok) {
            if (data.enrollment_complete) {
                window.showMessage('üéâ ' + data.message, 'success');
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 2000);
            } else {
                // ‚Üê –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –≤–º–µ—Å—Ç–æ fetchSampleCount
                samplesCollected++;  // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                updateProgressBar();  // –û–±–Ω–æ–≤–ª—è–µ–º UI

                window.showMessage(data.message, 'success');

                // –°–±—Ä–æ—Å –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±—Ä–∞–∑—Ü–∞
                setTimeout(() => {
                    inputArea.value = '';
                    keystrokeEvents = [];
                    currentIndex = 0;
                    startBtn.style.display = 'block';
                    submitBtn.style.display = 'none';
                    clearBtn.disabled = false;
                    inputArea.disabled = false;
                    submitBtn.disabled = false;
                    submitBtn.textContent = '‚úì –ó–∞–≤–µ—Ä—à–∏—Ç—å';
                    statsDiv.style.display = 'none';
                    // –°–±—Ä–æ—Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
                    enrollmentDisplay.innerHTML = enrollmentText;
                }, 1500);
            }
        } else {
            window.showMessage('–û—à–∏–±–∫–∞: ' + data.error, 'error');
            startBtn.style.display = 'block';
            submitBtn.style.display = 'none';
            clearBtn.disabled = false;
            inputArea.disabled = false;
        }
    } catch (error) {
        window.showMessage('–û—à–∏–±–∫–∞: ' + error.message, 'error');
        startBtn.style.display = 'block';
        submitBtn.style.display = 'none';
        clearBtn.disabled = false;
        inputArea.disabled = false;
    }

    submitBtn.disabled = false;
    submitBtn.textContent = '‚úì –ó–∞–≤–µ—Ä—à–∏—Ç—å';
});

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–∞–∂–∞—Ç–∏–π –∫–ª–∞–≤–∏—à
inputArea.addEventListener('keydown', (e) => {
    if (!isRecording) return;

    const char = e.key;

    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –º—ã –Ω–µ –≤—ã—à–ª–∏ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —Ç–µ–∫—Å—Ç–∞
    if (currentIndex >= enrollmentText.length) {
        e.preventDefault();
        window.showMessage('–¢–µ–∫—Å—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–≤–µ–¥–µ–Ω! –ù–∞–∂–º–∏—Ç–µ "–ó–∞–≤–µ—Ä—à–∏—Ç—å".', 'info');
        return;
    }

    const expectedChar = enrollmentText[currentIndex];

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ (—Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ –ø—Ä–æ–±–µ–ª—ã)
    if (char.length === 1) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ —Å–∏–º–≤–æ–ª
        if (char.toLowerCase() === expectedChar.toLowerCase() || (char === ' ' && expectedChar === ' ')) {
            // –ü–æ–∑–≤–æ–ª—è–µ–º –≤–≤–æ–¥–∏—Ç—å —Å–∏–º–≤–æ–ª, –Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –µ–≥–æ
            keystrokeEvents.push({
                keycode: e.keyCode,
                key_char: char,
                press_time: Date.now() - startTime,
                release_time: null
            });
        } else {
            // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–º–≤–æ–ª - –±–ª–æ–∫–∏—Ä—É–µ–º –µ–≥–æ –≤–≤–æ–¥
            e.preventDefault();
            window.showMessage(`–û–∂–∏–¥–∞–µ—Ç—Å—è "${expectedChar}", –≤–≤–µ–¥–µ–Ω "${char}"`, 'error');
            return;
        }
    } else if (e.key === 'Backspace') {
        // –†–∞–∑—Ä–µ—à–∞–µ–º Backspace –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
        if (keystrokeEvents.length > 0) {
            keystrokeEvents.pop();
            if (currentIndex > 0) {
                currentIndex--;
            }
        }
        return;
    } else {
        // –ó–∞–ø—Ä–µ—â–∞–µ–º –¥—Ä—É–≥–∏–µ –∫–ª–∞–≤–∏—à–∏ (—Å—Ç—Ä–µ–ª–∫–∏, Enter –∏ —Ç.–¥.)
        if (e.key !== 'Control' && e.key !== 'Shift' && e.key !== 'Alt') {
            e.preventDefault();
        }
        return;
    }
});

inputArea.addEventListener('keyup', (e) => {
    if (!isRecording) return;

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
    const typed = inputArea.value;
    let matchCount = 0;

    for (let i = 0; i < typed.length && i < enrollmentText.length; i++) {
        if (typed[i].toLowerCase() === enrollmentText[i].toLowerCase()) {
            matchCount++;
        }
    }

    currentIndex = matchCount;

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
    updateHighlight();

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    updateStats();

    // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–ø—É—Å–∫–∞–Ω–∏—è –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–±—ã—Ç–∏—è
    if (keystrokeEvents.length > 0) {
        const lastEvent = keystrokeEvents[keystrokeEvents.length - 1];
        if (lastEvent.release_time === null) {
            lastEvent.release_time = Date.now() - startTime;
        }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞: –ø–æ–ª–Ω–æ—Å—Ç—å—é –ª–∏ –Ω–∞–ø–µ—á–∞—Ç–∞–Ω —Ç–µ–∫—Å—Ç
    if (typed.length === enrollmentText.length && calculateAccuracy(typed, enrollmentText) >= 0.95) {
        setTimeout(() => {
            window.showMessage('–¢–µ–∫—Å—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–≤–µ–¥–µ–Ω! –ù–∞–∂–º–∏—Ç–µ "–ó–∞–≤–µ—Ä—à–∏—Ç—å".', 'success');
        }, 300);
    }
});

function updateHighlight() {
    const typed = inputArea.value;
    let highlightedText = '';

    for (let i = 0; i < enrollmentText.length; i++) {
        if (i < typed.length) {
            if (typed[i].toLowerCase() === enrollmentText[i].toLowerCase()) {
                highlightedText += enrollmentText[i];
            } else {
                // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–º–≤–æ–ª
                highlightedText += '<span style="color: red;">' + enrollmentText[i] + '</span>';
            }
        } else if (i === typed.length) {
            // –¢–µ–∫—É—â–∏–π —Å–∏–º–≤–æ–ª –¥–ª—è –ø–µ—á–∞—Ç–∏
            highlightedText += '<span style="background: #ffeb3b; font-weight: bold;">' + enrollmentText[i] + '</span>';
        } else {
            // –û—Å—Ç–∞–≤—à–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã
            highlightedText += enrollmentText[i];
        }
    }

    enrollmentDisplay.innerHTML = highlightedText;
}

function calculateAccuracy(typed, expected) {
    if (expected.length === 0) return 0;

    const minLen = Math.min(typed.length, expected.length);
    let matches = 0;

    for (let i = 0; i < minLen; i++) {
        if (typed[i].toLowerCase() === expected[i].toLowerCase()) {
            matches++;
        }
    }

    // –£—á–∏—Ç—ã–≤–∞–µ–º —Ç–∞–∫–∂–µ –¥–ª–∏–Ω—É: –µ—Å–ª–∏ –Ω–∞–ø–µ—á–∞—Ç–∞–Ω–æ –±–æ–ª—å—à–µ –∏–ª–∏ –º–µ–Ω—å—à–µ —Å–∏–º–≤–æ–ª–æ–≤
    if (typed.length !== expected.length) {
        return matches / expected.length * 0.95;
    }

    return matches / expected.length;
}

function updateStats() {
    if (keystrokeEvents.length < 2) return;

    statsDiv.style.display = 'block';

    // Dwell times
    const dwellTimes = keystrokeEvents.map(e => e.release_time - e.press_time).filter(t => t > 0);
    const avgDwell = dwellTimes.length > 0 ? (dwellTimes.reduce((a, b) => a + b) / dwellTimes.length).toFixed(0) : 0;

    // Flight times
    const flightTimes = [];
    for (let i = 0; i < keystrokeEvents.length - 1; i++) {
        const flight = keystrokeEvents[i + 1].press_time - keystrokeEvents[i].release_time;
        if (flight >= 0) flightTimes.push(flight);
    }
    const avgFlight = flightTimes.length > 0 ? (flightTimes.reduce((a, b) => a + b) / flightTimes.length).toFixed(0) : 0;

    // Typing speed
    const totalTime = (keystrokeEvents[keystrokeEvents.length - 1].release_time - keystrokeEvents[0].press_time) / 1000;
    const speed = totalTime > 0 ? (keystrokeEvents.length / totalTime).toFixed(1) : 0;

    // Accuracy
    const typed = inputArea.value;
    const accuracy = calculateAccuracy(typed, enrollmentText);

    document.getElementById('dwellTime').textContent = avgDwell;
    document.getElementById('flightTime').textContent = avgFlight;
    document.getElementById('typingSpeed').textContent = speed;
    document.getElementById('accuracy').textContent = (accuracy * 100).toFixed(0) + '%';
}
</script>
{% endblock %}
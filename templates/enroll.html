{% extends "base.html" %}

{% block title %}Ğ­Ğ½Ñ€Ğ¾Ğ»Ğ¼ĞµĞ½Ñ‚ Ğ¿Ğ¾Ñ‡ĞµÑ€ĞºĞ° - Keystroke Dynamics Auth{% endblock %}

{% block body %}
<div class="container">
    <div class="card" style="max-width: 600px; margin: 0 auto;">
        <div class="header">
            <h1>âœï¸ Ğ­Ğ½Ñ€Ğ¾Ğ»Ğ¼ĞµĞ½Ñ‚ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ñ‡ĞµÑ€ĞºĞ°</h1>
            <p>Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ²Ğ°ÑˆĞµĞ³Ğ¾ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ÑÑ‚Ğ¸Ğ»Ñ Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ¸</p>
        </div>
        <div class="content">
            <div id="message" class="message"></div>

            <div class="progress">
                <div class="progress-bar">
                    <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
                </div>
                <div style="text-align: center; font-size: 12px; color: #666; margin-top: 8px;">
                    ĞĞ±Ñ€Ğ°Ğ·ĞµÑ† <span id="sampleNum">1</span> Ğ¸Ğ· <span id="totalSamples">5</span>
                </div>
            </div>

            <div style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 20px 0;">
                <p style="font-size: 12px; color: #666; margin-bottom: 10px;"><strong>ğŸ“ Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ:</strong></p>
                <ul style="font-size: 12px; color: #666; padding-left: 20px;">
                    <li>ĞŸÑ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ¹Ñ‚Ğµ Ñ‚ĞµĞºÑÑ‚ Ğ½Ğ¸Ğ¶Ğµ</li>
                    <li>ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ "ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ"</li>
                    <li>ĞŸĞµÑ‡Ğ°Ñ‚Ğ°Ğ¹Ñ‚Ğµ Ñ‚ĞµĞºÑÑ‚ Ñ€Ğ¾Ğ²Ğ½Ğ¾ ĞºĞ°Ğº Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ğ½Ğ¾</li>
                    <li>Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ±ÑƒĞ´ĞµÑ‚ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ²Ğ°Ñˆ Ğ¿Ğ¾Ñ‡ĞµÑ€Ğº</li>
                    <li>ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ" ĞºĞ¾Ğ³Ğ´Ğ° Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ñ‚Ğµ</li>
                </ul>
            </div>

            <div style="background: #e8f5e9; padding: 15px; border-radius: 5px; margin: 20px 0; text-align: center;">
                <p style="font-size: 14px; font-weight: bold; color: #2e7d32;" id="enrollmentText">
                    The quick brown fox jumps over the lazy dog
                </p>
            </div>

            <div class="form-group">
                <label for="inputArea">Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‚ĞµĞºÑÑ‚ Ğ·Ğ´ĞµÑÑŒ:</label>
                <textarea id="inputArea" placeholder="ĞŸĞµÑ‡Ğ°Ñ‚Ğ°Ğ¹Ñ‚Ğµ Ñ‚ĞµĞºÑÑ‚ Ğ·Ğ´ĞµÑÑŒ..."></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button type="button" class="btn btn-primary" id="startBtn" style="flex: 1;">â–¶ ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ</button>
                <button type="button" class="btn btn-secondary" id="clearBtn" style="flex: 1;">â†» ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ</button>
                <button type="button" class="btn btn-secondary" id="submitBtn" style="flex: 1; display: none;">âœ“ Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ</button>
            </div>

            <div id="stats" style="display: none; margin-top: 20px;">
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="typingSpeed">0</div>
                        <div class="stat-label">Ğ¡Ğ¸Ğ¼/ÑĞµĞº</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="dwellTime">0</div>
                        <div class="stat-label">ĞœÑ (Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ğµ)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="flightTime">0</div>
                        <div class="stat-label">ĞœÑ (Ğ¼ĞµĞ¶Ğ´Ñƒ)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="accuracy">0%</div>
                        <div class="stat-label">Ğ¢Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const enrollmentText = "The quick brown fox jumps over the lazy dog";
const inputArea = document.getElementById('inputArea');
const startBtn = document.getElementById('startBtn');
const clearBtn = document.getElementById('clearBtn');
const submitBtn = document.getElementById('submitBtn');
const enrollmentDisplay = document.getElementById('enrollmentText');
const statsDiv = document.getElementById('stats');

let keystrokeEvents = [];
let isRecording = false;
let startTime = 0;
let samplesCollected = 0;

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ-Ğ±Ğ°Ñ€Ğ° (Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ)
function updateProgressBar() {
    const currentSample = samplesCollected + 1;
    document.getElementById('sampleNum').textContent = currentSample;
    document.getElementById('progressBar').style.width = (currentSample / 5 * 100) + '%';
    console.log('Progress updated:', currentSample, '/', 5);
}

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´ÑÑ‡ĞµÑ‚Ğ° Ğ¾Ğ±Ñ€Ğ°Ğ·Ñ†Ğ¾Ğ² Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ°
async function fetchSampleCount() {
    try {
        const stats = await fetch('/api/profile-stats').then(r => r.json());
        samplesCollected = stats.profiles_count;
        updateProgressBar();
        console.log('Samples from server:', samplesCollected);
    } catch (e) {
        console.log('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ:', e);
    }
}

// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ
fetchSampleCount();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ¹ Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ· input event
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

startBtn.addEventListener('click', () => {
    inputArea.disabled = false;
    inputArea.focus();
    inputArea.value = '';
    keystrokeEvents = [];
    isRecording = true;
    startTime = Date.now();

    startBtn.style.display = 'none';
    submitBtn.style.display = 'block';
    statsDiv.style.display = 'none';
    clearBtn.disabled = true;

    // Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ñ‚ĞµĞºÑÑ‚Ğ°
    enrollmentDisplay.innerHTML = '<span style="background: #ffeb3b; font-weight: bold;">' + enrollmentText[0] + '</span>' + enrollmentText.substring(1);

    window.showMessage('ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ğ¹Ñ‚Ğµ Ğ¿ĞµÑ‡Ğ°Ñ‚ÑŒ...', 'info');
});

clearBtn.addEventListener('click', () => {
    inputArea.value = '';
    keystrokeEvents = [];
    statsDiv.style.display = 'none';
    enrollmentDisplay.innerHTML = enrollmentText;
});

submitBtn.addEventListener('click', async () => {
    isRecording = false;
    inputArea.disabled = true;

    const typed = inputArea.value.trim();
    const accuracy = calculateAccuracy(typed, enrollmentText);

    console.log('Typed:', typed);
    console.log('Expected:', enrollmentText);
    console.log('Accuracy:', accuracy);
    console.log('Keystroke events:', keystrokeEvents.length);

    if (accuracy < 0.8) {
        window.showMessage(`Ğ¢ĞµĞºÑÑ‚ Ğ²Ğ²ĞµĞ´ĞµĞ½ Ğ½ĞµĞ²ĞµÑ€Ğ½Ğ¾ (Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ: ${(accuracy * 100).toFixed(0)}%). ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ°.`, 'error');
        startBtn.style.display = 'block';
        submitBtn.style.display = 'none';
        clearBtn.disabled = false;
        inputArea.disabled = false;
        isRecording = false;
        return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°...';

    try {
        const response = await fetch('/enroll', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ keystroke_events: keystrokeEvents })
        });

        const data = await response.json();

        if (response.ok) {
            if (data.enrollment_complete) {
                window.showMessage('ğŸ‰ ' + data.message, 'success');
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 2000);
            } else {
                samplesCollected++;
                updateProgressBar();

                window.showMessage(data.message, 'success');

                setTimeout(() => {
                    inputArea.value = '';
                    keystrokeEvents = [];
                    startBtn.style.display = 'block';
                    submitBtn.style.display = 'none';
                    clearBtn.disabled = false;
                    inputArea.disabled = false;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'âœ“ Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ';
                    statsDiv.style.display = 'none';
                    enrollmentDisplay.innerHTML = enrollmentText;
                }, 1500);
            }
        } else {
            window.showMessage('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + data.error, 'error');
            startBtn.style.display = 'block';
            submitBtn.style.display = 'none';
            clearBtn.disabled = false;
            inputArea.disabled = false;
        }
    } catch (error) {
        window.showMessage('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + error.message, 'error');
        startBtn.style.display = 'block';
        submitBtn.style.display = 'none';
        clearBtn.disabled = false;
        inputArea.disabled = false;
    }

    submitBtn.disabled = false;
    submitBtn.textContent = 'âœ“ Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞĞ¡ĞĞĞ’ĞĞĞ• Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· keydown/keyup
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ğ¹ ĞºĞ»Ğ°Ğ²Ğ¸Ñˆ (ĞĞĞ–ĞĞ¢Ğ˜Ğ•)
inputArea.addEventListener('keydown', (e) => {
    if (!isRecording) return;

    const char = e.key;

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†
    const currentPosition = inputArea.value.length;

    if (currentPosition >= enrollmentText.length) {
        if (char !== 'Backspace') {
            e.preventDefault();
            window.showMessage('Ğ¢ĞµĞºÑÑ‚ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ²Ğ²ĞµĞ´ĞµĞ½! ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ".', 'info');
        }
        return;
    }

    // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Backspace
    if (e.key === 'Backspace') {
        if (keystrokeEvents.length > 0) {
            keystrokeEvents.pop();
        }
        return;
    }

    // Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ ÑĞ¿ĞµÑ†ĞºĞ»Ğ°Ğ²Ğ¸ÑˆĞ¸
    if (e.key.length !== 1) {
        if (e.key !== 'Control' && e.key !== 'Shift' && e.key !== 'Alt') {
            e.preventDefault();
        }
        return;
    }

    // âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•: ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞĞ–Ğ˜Ğ”ĞĞ•ĞœĞ«Ğ™ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ» Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ´Ğ»Ğ¸Ğ½Ñ‹
    const currentLength = inputArea.value.length;
    const expectedChar = enrollmentText[currentLength];

    // âœ… ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ (Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ° Ğ¸ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ğ¾Ğ²)
    const charMatches = (
        char.toLowerCase() === expectedChar.toLowerCase() ||
        (char === ' ' && expectedChar === ' ')
    );

    if (!charMatches) {
        // âŒ ĞĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ» - Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼
        e.preventDefault();
        window.showMessage(`ĞĞ¶Ğ¸Ğ´Ğ°ĞµÑ‚ÑÑ "${expectedChar}", Ğ²Ğ²ĞµĞ´ĞµĞ½ "${char}"`, 'error');
        return;
    }

    // âœ… ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ» - Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ğµ
    keystrokeEvents.push({
        keycode: e.keyCode,
        key_char: char,
        press_time: Date.now() - startTime,
        release_time: null,
        index: currentLength  // â† Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ½Ğ´ĞµĞºÑ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸
    });
});

// ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ‚Ğ¿ÑƒÑĞºĞ°Ğ½Ğ¸Ñ ĞºĞ»Ğ°Ğ²Ğ¸Ñˆ (ĞĞ¢ĞŸĞ£Ğ¡ĞšĞĞĞ˜Ğ•)
inputArea.addEventListener('keyup', (e) => {
    if (!isRecording) return;

    // ĞĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ´Ğ»Ñ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ñ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ¾Ğ¼
    setTimeout(() => {
        if (!isRecording) return;

        // Ğ¤Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ¾Ñ‚Ğ¿ÑƒÑĞºĞ°Ğ½Ğ¸Ñ
        if (keystrokeEvents.length > 0) {
            const lastEvent = keystrokeEvents[keystrokeEvents.length - 1];
            if (lastEvent.release_time === null || lastEvent.release_time === undefined) {
                lastEvent.release_time = Date.now() - startTime;
            }
        }

        updateHighlight();
        updateStats();

        const typed = inputArea.value;
        if (typed.length === enrollmentText.length && calculateAccuracy(typed, enrollmentText) >= 0.95) {
            setTimeout(() => {
                window.showMessage('Ğ¢ĞµĞºÑÑ‚ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ²Ğ²ĞµĞ´ĞµĞ½! ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ñ‚ÑŒ".', 'success');
            }, 300);
        }
    }, 0);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ”ĞĞŸĞĞ›ĞĞ˜Ğ¢Ğ•Ğ›Ğ¬ĞĞĞ¯ ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ: Ğ›Ğ¾Ğ²Ğ¸Ğ¼ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ/Ğ²ÑÑ‚Ğ°Ğ²ĞºĞ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

inputArea.addEventListener('paste', (e) => {
    e.preventDefault();
    window.showMessage('ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ/Ğ²ÑÑ‚Ğ°Ğ²ĞºĞ° Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰ĞµĞ½Ñ‹. ĞŸĞµÑ‡Ğ°Ñ‚Ğ°Ğ¹Ñ‚Ğµ Ñ‚ĞµĞºÑÑ‚ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ.', 'error');
});

inputArea.addEventListener('cut', (e) => {
    e.preventDefault();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ĞŸĞĞ”Ğ¡Ğ’Ğ•Ğ¢ĞšĞ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateHighlight() {
    const typed = inputArea.value;
    let highlightedText = '';

    for (let i = 0; i < enrollmentText.length; i++) {
        if (i < typed.length) {
            // Ğ¡Ğ¸Ğ¼Ğ²Ğ¾Ğ» Ğ½Ğ°Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ°Ğ½
            if (typed[i].toLowerCase() === enrollmentText[i].toLowerCase()) {
                // âœ… ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»
                highlightedText += enrollmentText[i];
            } else {
                // âŒ ĞĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ» (ĞºÑ€Ğ°ÑĞ½Ñ‹Ğ¹)
                highlightedText += '<span style="color: red;">' + enrollmentText[i] + '</span>';
            }
        } else if (i === typed.length) {
            // Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ» Ğ´Ğ»Ñ Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ¸ (Ğ¶ĞµĞ»Ñ‚Ñ‹Ğ¹ Ñ„Ğ¾Ğ½)
            highlightedText += '<span style="background: #ffeb3b; font-weight: bold;">' + enrollmentText[i] + '</span>';
        } else {
            // ĞÑÑ‚Ğ°Ğ²ÑˆĞ¸ĞµÑÑ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹ (ÑĞµÑ€Ñ‹Ğµ)
            highlightedText += enrollmentText[i];
        }
    }

    enrollmentDisplay.innerHTML = highlightedText;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ ĞĞ¡Ğ§Ğ•Ğ¢ Ğ¢ĞĞ§ĞĞĞ¡Ğ¢Ğ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function calculateAccuracy(typed, expected) {
    if (expected.length === 0) return 0;

    const minLen = Math.min(typed.length, expected.length);
    let matches = 0;

    for (let i = 0; i < minLen; i++) {
        if (typed[i].toLowerCase() === expected[i].toLowerCase()) {
            matches++;
        }
    }

    // Ğ£Ñ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ°ĞºĞ¶Ğµ Ğ´Ğ»Ğ¸Ğ½Ñƒ
    if (typed.length !== expected.length) {
        return matches / expected.length * 0.95;
    }

    return matches / expected.length;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateStats() {
    if (keystrokeEvents.length < 2) return;

    statsDiv.style.display = 'block';

    // Dwell times (Ğ²Ñ€ĞµĞ¼Ñ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ñ)
    const dwellTimes = keystrokeEvents.map(e => e.release_time - e.press_time).filter(t => t > 0);
    const avgDwell = dwellTimes.length > 0 ? (dwellTimes.reduce((a, b) => a + b) / dwellTimes.length).toFixed(0) : 0;

    // Flight times (Ğ²Ñ€ĞµĞ¼Ñ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸ÑĞ¼Ğ¸)
    const flightTimes = [];
    for (let i = 0; i < keystrokeEvents.length - 1; i++) {
        const flight = keystrokeEvents[i + 1].press_time - keystrokeEvents[i].release_time;
        if (flight >= 0) flightTimes.push(flight);
    }
    const avgFlight = flightTimes.length > 0 ? (flightTimes.reduce((a, b) => a + b) / flightTimes.length).toFixed(0) : 0;

    // Typing speed (ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ¸)
    const totalTime = (keystrokeEvents[keystrokeEvents.length - 1].release_time - keystrokeEvents[0].press_time) / 1000;
    const speed = totalTime > 0 ? (keystrokeEvents.length / totalTime).toFixed(1) : 0;

    // Accuracy (Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ)
    const typed = inputArea.value;
    const accuracy = calculateAccuracy(typed, enrollmentText);

    document.getElementById('dwellTime').textContent = avgDwell;
    document.getElementById('flightTime').textContent = avgFlight;
    document.getElementById('typingSpeed').textContent = speed;
    document.getElementById('accuracy').textContent = (accuracy * 100).toFixed(0) + '%';
}
</script>
{% endblock %}